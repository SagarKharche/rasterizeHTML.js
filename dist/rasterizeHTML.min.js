/*! rasterizeHTML.js - v1.2.4 - 2018-01-17
* http://www.github.com/cburgmer/rasterizeHTML.js
* Copyright (c) 2018 Christoph Burgmer; Licensed MIT */

!function(e,t){"function"==typeof define&&define.amd?define(["url","xmlserializer","sane-domparser-error","inlineresources"],function(n,r,o,i){return e.rasterizeHTML=t(n,r,o,i)}):"object"==typeof module&&module.exports?module.exports=t(require("url"),require("xmlserializer"),require("sane-domparser-error"),require("inlineresources")):e.rasterizeHTML=t(e.url,e.xmlserializer,e.sanedomparsererror,e.inlineresources)}(this,function(e,t,n,r){var o=function(e){"use strict";var t={},n=[];t.joinUrl=function(t,n){return t?e.resolve(t,n):n},t.getConstantUniqueIdFor=function(e){return n.indexOf(e)<0&&n.push(e),n.indexOf(e)},t.clone=function(e){var t,n={};for(t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n};return t.parseOptionalParameters=function(e){var n,r,o={canvas:null,options:{}};return null==e[0]||(n=e[0],"object"==typeof(r=n)&&null!==r&&Object.prototype.toString.apply(n).match(/\[object (Canvas|HTMLCanvasElement)\]/i))?(o.canvas=e[0]||null,o.options=t.clone(e[1])):o.options=t.clone(e[0]),o},t}(e),i=function(e){"use strict";var t={},n=function(e,t,n){var r=e[t];return e[t]=function(){var e=Array.prototype.slice.call(arguments);return n.apply(this,[e,r])},r};return t.baseUrlRespectingXhr=function(t,r){return function(){var o=new t;return n(o,"open",function(t,n){var o=t.shift(),i=t.shift(),c=e.joinUrl(r,i);return n.apply(this,[o,c].concat(t))}),o}},t.finishNotifyingXhr=function(e){var t,r=0,o=0,i=!1,c=new Promise(function(e){t=function(){r-o<=0&&i&&e({totalCount:r})}}),u=function(){var i=new e;return n(i,"send",function(e,t){return r+=1,t.apply(this,arguments)}),i.addEventListener("load",function(){o+=1,t()}),i};return u.waitForRequestsToFinish=function(){return i=!0,t(),c},u},t}(o),c=function(e){"use strict";var t={},n=function(e){return Array.prototype.slice.call(e)},r={active:!0,hover:!0,focus:!1,target:!1};return t.fakeUserAction=function(t,n,o){var i=t.querySelector(n),c=":"+o,u="rasterizehtml"+o;i&&(r[o]?e.addClassNameRecursively(i,u):e.addClassName(i,u),e.rewriteCssSelectorWith(t,c,"."+u))},t.persistInputValues=function(e){var t=e.querySelectorAll("input"),r=e.querySelectorAll("textarea"),o=function(e){return"checkbox"===e.type||"radio"===e.type};n(t).filter(o).forEach(function(e){e.checked?e.setAttribute("checked",""):e.removeAttribute("checked")}),n(t).filter(function(e){return!o(e)}).forEach(function(e){e.setAttribute("value",e.value)}),n(r).forEach(function(e){e.textContent=e.value})},t.rewriteTagNameSelectorsToLowerCase=function(t){e.lowercaseCssTypeSelectors(t,e.findHtmlOnlyNodeNames(t))},t}(function(){"use strict";var e={},t=function(e){return Array.prototype.slice.call(e)};e.addClassName=function(e,t){e.className+=" "+t},e.addClassNameRecursively=function(t,n){e.addClassName(t,n),t.parentNode!==t.ownerDocument&&e.addClassNameRecursively(t.parentNode,n)};var n=function(e,n){var r,o,i,c,u=e.cssText.replace(/^[^\{]+/,"");o=n+" "+u,i=(r=e).parentStyleSheet,c=t(i.cssRules).indexOf(r),i.insertRule(o,c+1),i.deleteRule(c)},r=function(e){var n;e.textContent=(n=e.sheet.cssRules,t(n).reduce(function(e,t){return e+t.cssText},""))},o=function(e,o,i){var c="((?:^|[^.#:\\w])|(?=\\W))("+o.join("|")+")(?=\\W|$)";t(e.querySelectorAll("style")).forEach(function(e){var o,u,a;void 0===e.sheet&&(o=e,u=document.implementation.createHTMLDocument(""),(a=document.createElement("style")).textContent=o.textContent,u.body.appendChild(a),o.sheet=a.sheet);var s=t(e.sheet.cssRules).filter(function(e){return e.selectorText&&new RegExp(c,"i").test(e.selectorText)});s.length&&(s.forEach(function(e){var t=e.selectorText.replace(new RegExp(c,"gi"),function(e,t,n){return t+i(n)});t!==e.selectorText&&n(e,t)}),r(e))})};return e.rewriteCssSelectorWith=function(e,t,n){o(e,[t],function(){return n})},e.lowercaseCssTypeSelectors=function(e,t){o(e,t,function(e){return e.toLowerCase()})},e.findHtmlOnlyNodeNames=function(e){var t,n=e.ownerDocument.createTreeWalker(e,NodeFilter.SHOW_ELEMENT),r={},o={};do{t=n.currentNode.tagName.toLowerCase(),"http://www.w3.org/1999/xhtml"===n.currentNode.namespaceURI?r[t]=!0:o[t]=!0}while(n.nextNode());return Object.keys(r).filter(function(e){return!o[e]})},e}()),u=function(e,t,n,r){"use strict";var o={};o.executeJavascript=function(e,n){return new Promise(function(o){var i,c,u,a,s,l=(i=r.document,c="iframe",u=n.width,a=n.height,(s=i.createElement(c)).style.visibility="hidden",s.style.width=u+"px",s.style.height=a+"px",s.style.position="absolute",s.style.top=-1e4-a+"px",s.style.left=-1e4-u+"px",i.getElementsByTagName("body")[0].appendChild(s),s),m=e.outerHTML,f=[],d=n.executeJsTimeout||0,h=function(){var e=l.contentDocument;r.document.getElementsByTagName("body")[0].removeChild(l),o({document:e,errors:f})},p=l.contentWindow.XMLHttpRequest,v=t.finishNotifyingXhr(p),g=t.baseUrlRespectingXhr(v,n.baseUrl);l.onload=function(){var e;(e=d,e>0?new Promise(function(t){setTimeout(t,e)}):Promise.resolve()).then(v.waitForRequestsToFinish).then(h)},l.contentDocument.open(),l.contentWindow.XMLHttpRequest=g,l.contentWindow.onerror=function(e){f.push({resourceType:"scriptExecution",msg:e})},l.contentDocument.write("<!DOCTYPE html>"),l.contentDocument.write(m),l.contentDocument.close()})};var i=function(e,t,n,o,i){var c,u,a,s,l,m,f,d,h,p,v,g=Math.max(e.scrollWidth,e.clientWidth),w=Math.max(e.scrollHeight,e.clientHeight);return t?(c=(m=function(e,t){var n=e.querySelector(t);if(n)return n;if(e.ownerDocument.querySelector(t)===e)return e;throw{message:"Clipping selector not found"}}(e,t).getBoundingClientRect()).top,u=m.left,a=m.width,s=m.height):(c=0,u=0,a=g,s=w),d={width:a,height:s},h=n,p=o,v=i,f={width:Math.max(d.width*v,h),height:Math.max(d.height*v,p)},l=r.getComputedStyle(e.ownerDocument.documentElement).fontSize,{left:u,top:c,width:f.width,height:f.height,viewportWidth:g,viewportHeight:w,rootFontSize:l}};o.calculateDocumentContentSize=function(e,t){return new Promise(function(n,o){var c,u,a,s,l,m,f,d,h,p,v,g,w=t.zoom||1;u=t.width,a=t.height,s=w,h=Math.floor(u/s),p=Math.floor(a/s),l=r.document,m=h,f=p,(d=l.createElement("iframe")).style.width=m+"px",d.style.height=f+"px",d.style.visibility="hidden",d.style.position="absolute",d.style.top=-1e4-f+"px",d.style.left=-1e4-m+"px",d.style.borderWidth=0,d.sandbox="allow-same-origin",d.scrolling="no",c=d,r.document.getElementsByTagName("body")[0].appendChild(c),c.onload=function(){var u,a,s,l=c.contentDocument;try{u=i((a=l,s=e.tagName,a.querySelector(s)),t.clip,t.width,t.height,w),n(u)}catch(e){o(e)}finally{r.document.getElementsByTagName("body")[0].removeChild(c)}},c.contentDocument.open(),c.contentDocument.write("<!DOCTYPE html>"),c.contentDocument.write("html"===(g=(v=e).tagName.toLowerCase())||"body"===g?v.outerHTML:'<body style="margin: 0;">'+v.outerHTML+"</body>"),c.contentDocument.close()})},o.parseHtmlFragment=function(e){var t=r.document.implementation.createHTMLDocument("");t.documentElement.innerHTML=e;var n=t.querySelector("body").firstChild;if(!n)throw"Invalid source";return n};o.parseHTML=function(e){var t=r.document.implementation.createHTMLDocument("");return t.documentElement.innerHTML=e,function(e,t){var n,o,i,c,u=/<html((?:\s+[^>]*)?)>/im.exec(t),a=r.document.implementation.createHTMLDocument("");if(u)for(n="<div"+u[1]+"></div>",a.documentElement.innerHTML=n,i=a.querySelector("div"),o=0;o<i.attributes.length;o++)c=i.attributes[o],e.documentElement.setAttribute(c.name,c.value)}(t,e),t};var c=function(e){try{return n.failOnParseError(e)}catch(e){throw{message:"Invalid source",originalError:e}}};o.validateXHTML=function(e){var t=(new DOMParser).parseFromString(e,"application/xml");c(t)};var u=null,a=function(t,n){return new Promise(function(r,o){var i,c,a=new window.XMLHttpRequest,s=e.joinUrl(n.baseUrl,t),l=(i=s,"none"===(c=n.cache)||"repeated"===c?(null!==u&&"repeated"===c||(u=Date.now()),i+"?_="+u):i),m=function(e){o({message:"Unable to load page",originalError:e})};a.addEventListener("load",function(){200===a.status||0===a.status?r(a.responseXML):m(a.statusText)},!1),a.addEventListener("error",function(e){m(e)},!1);try{a.open("GET",l,!0),a.responseType="document",a.send(null)}catch(e){m(e)}})};return o.loadDocument=function(e,t){return a(e,t).then(function(e){return c(e)})},o}(o,i,n,window),a=function(e){"use strict";var t,n={},r=function(e,t){return t?URL.createObjectURL(new Blob([e],{type:"image/svg+xml"})):"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(e)},o=function(e){e instanceof Blob&&URL.revokeObjectURL(e)},i='<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"><foreignObject></foreignObject></svg>',c=function(e){return new Promise(function(t,n){var r=document.createElement("canvas"),o=new Image;o.onload=function(){var e=r.getContext("2d");try{e.drawImage(o,0,0),r.toDataURL("image/png"),t(!0)}catch(e){t(!1)}},o.onerror=n,o.src=e})},u=function(){return new Promise(function(t,n){var u;(function(){if(e.Blob)try{return new Blob(["<b></b>"],{type:"text/xml"}),!0}catch(e){}return!1})()&&e.URL?(u=r(i,!0),c(u).then(function(e){return o(u),!e&&c(r(i,!1)).then(function(e){return e})},function(){return!1})).then(function(e){t(!e)},function(){n()}):t(!1)})},a=function(e){return(void 0===t&&(t=u()),t).then(function(t){return r(e,t)})};return n.renderSvg=function(e){return new Promise(function(t,n){var r,i,c=function(){r&&o(r)};(i=new Image).onload=function(){i.onload=null,i.onerror=null,c(),t(i)},i.onerror=function(){c(),n()},a(e).then(function(e){r=e,i.src=r},n)})},n}(window);return function(e,t,n){"use strict";var r={};r.drawDocument=function(){var t,r,o,i,c,u,a,s=arguments[0],l=Array.prototype.slice.call(arguments,1),m=e.parseOptionalParameters(l),f=s.documentElement?s.documentElement:s;return n.rasterize(f,m.canvas,(o=(t=m).canvas,i=t.options,c=o?o.width:300,u=o?o.height:200,a={width:void 0!==i.width?i.width:c,height:void 0!==i.height?i.height:u},(r=e.clone(t.options)).width=a.width,r.height=a.height,r))};r.drawHTML=function(){var n,o,i,c,u=arguments[0],a=Array.prototype.slice.call(arguments,1),s=e.parseOptionalParameters(a);return n=u,o=s.canvas,i=s.options,c=t.parseHTML(n),r.drawDocument(c,o,i)};var o=function(n,o,i){return t.loadDocument(n,i).then(function(t){var c=function(t,n,r){var o=document.implementation.createHTMLDocument("");o.replaceChild(t.documentElement,o.documentElement);var i=r?e.clone(r):{};return r.baseUrl||(i.baseUrl=n),{document:o,options:i}}(t,n,i);return r.drawDocument(c.document,o,c.options)})};return r.drawURL=function(){var t=arguments[0],n=Array.prototype.slice.call(arguments,1),r=e.parseOptionalParameters(n);return o(t,r.canvas,r.options)},r}(o,u,function(e,t,n,r,o,i){"use strict";var c={},u=function(e){return{message:"Error rendering page",originalError:e}},a=function(e){return o.renderSvg(e).then(function(t){return{image:t,svg:e}},function(e){throw u(e)})},s=function(e,t,n){return r.drawDocumentAsSvg(e,n).then(a).then(function(e){return t&&function(e,t){try{t.getContext("2d").drawImage(e,0,0)}catch(e){throw u(e)}}(e.image,t),e})};return c.rasterize=function(r,o,c){var u;return(u=e.clone(c)).inlineScripts=!0===c.executeJs,i.inlineReferences(r,u).then(function(e){return c.executeJs?(o=r,i=c,t.executeJavascript(o,i).then(function(e){var t=e.document;return n.persistInputValues(t),{document:t,errors:e.errors}})).then(function(t){return{element:t.document.documentElement,errors:e.concat(t.errors)}}):{element:r,errors:e};var o,i}).then(function(e){return s(e.element,o,c).then(function(t){return{image:t.image,svg:t.svg,errors:e.errors}})})},c}(o,u,c,function(e,t,n,r){"use strict";var o={},i=function(e){var t=Object.keys(e);return t.length?" "+t.map(function(t){return t+'="'+e[t]+'"'}).join(" "):""},c=function(e,n,o){var c=r.serializeToString(e);t.validateXHTML(c);var u,a,s,l,m,f,d,h,p=(u=n,a=Math.round(u.viewportWidth),s=Math.round(u.viewportHeight),{x:-u.left,y:-u.top,width:a,height:s});return m=(l=p).style||"",l.style=m+"float: left;",p.externalResourcesRequired=!0,'<svg xmlns="http://www.w3.org/2000/svg"'+i((f=n,d=o||1,h={width:f.width,height:f.height,"font-size":f.rootFontSize},1!==d&&(h.style="transform:scale("+d+"); transform-origin: 0 0;"),h))+'><style scoped="">html::-webkit-scrollbar { display: none; }</style><foreignObject'+i(p)+">"+c+"</foreignObject></svg>"};return o.getSvgForDocument=function(e,t,r){return n.rewriteTagNameSelectorsToLowerCase(e),c(e,t,r)},o.drawDocumentAsSvg=function(e,r){return["hover","active","focus","target"].forEach(function(t){r[t]&&n.fakeUserAction(e,r[t],t)}),t.calculateDocumentContentSize(e,r).then(function(t){return o.getSvgForDocument(e,t,r.zoom)})},o}(0,u,c,t),a,r))});